<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Pesan Martabak</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@400;600&display=swap" rel="stylesheet">
    <!-- Tone.js for notification sound -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.7.77/Tone.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .cart-slide-up { animation: slide-up 0.5s ease-out forwards; }
        @keyframes slide-up {
            from { transform: translateY(100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .order-card-enter { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        #receipt-paper {
            font-family: 'Source Code Pro', monospace;
        }
        @media print {
            body > *:not(#receipt-view) {
                display: none;
            }
            #receipt-view, #receipt-paper {
                display: block;
                margin: 0;
                padding: 0;
                box-shadow: none;
            }
            #receipt-controls {
                display: none;
            }
        }
    </style>
</head>
<body class="bg-gray-100">
    
    <!-- Tampilan Welcome -->
    <div id="welcome-view" class="hidden">
        <div class="min-h-screen flex items-center justify-center bg-amber-50">
            <div class="text-center p-8">
                <h1 class="text-5xl font-bold text-gray-800 mb-4">Martabak Ayesha</h1>
                <p class="text-xl text-gray-600 mb-12">Pesan martabak favoritmu sekarang!</p>
                <div class="space-y-4 max-w-sm mx-auto">
                    <button id="welcome-to-customer-login-btn" class="w-full bg-green-600 text-white font-bold py-4 rounded-lg text-lg hover:bg-green-700 transition-colors">Pesan Sekarang</button>
                    <div class="flex gap-4">
                        <button id="welcome-to-admin-login-btn" class="relative w-full bg-gray-200 text-gray-800 font-semibold py-3 rounded-lg hover:bg-gray-300 transition-colors">
                            Login Admin
                             <span id="admin-notification-badge" class="absolute top-2 right-2 flex h-3 w-3 hidden">
                                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-red-400 opacity-75"></span>
                                <span class="relative inline-flex rounded-full h-3 w-3 bg-red-500"></span>
                            </span>
                        </button>
                        <button id="welcome-to-boss-login-btn" class="w-full bg-blue-100 text-blue-800 font-semibold py-3 rounded-lg hover:bg-blue-200 transition-colors">Login Bos</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tampilan Login Pelanggan -->
    <div id="customer-login-view" class="hidden">
        <div class="min-h-screen flex items-center justify-center bg-amber-50">
            <div class="max-w-md w-full bg-white p-8 rounded-2xl shadow-lg">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-gray-800">Selamat Datang!</h1>
                    <p class="text-gray-500 mt-2">Silakan masukkan nama dan nomor WhatsApp Anda untuk melanjutkan.</p>
                </div>
                <form id="customer-login-form">
                    <div class="mb-4">
                        <label for="customer-name" class="block text-sm font-medium text-gray-700 mb-1">Nama</label>
                        <input type="text" id="customer-name" placeholder="Nama Anda" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500" required>
                    </div>
                    <div class="mb-6">
                        <label for="customer-whatsapp" class="block text-sm font-medium text-gray-700 mb-1">Nomor WhatsApp</label>
                        <input type="tel" id="customer-whatsapp" placeholder="cth: 08123456789" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500" required>
                    </div>
                    <button type="submit" class="w-full bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700 transition-colors">Masuk & Pesan</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Tampilan Login Bos -->
    <div id="login-view" class="hidden">
        <div class="min-h-screen flex items-center justify-center bg-gray-100">
            <div class="max-w-md w-full bg-white p-8 rounded-2xl shadow-lg">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-gray-800">Login Bos</h1>
                    <p class="text-gray-500 mt-2">Akses khusus untuk laporan penjualan.</p>
                </div>
                <form id="login-form">
                    <div class="mb-4">
                        <label for="login-id" class="block text-sm font-medium text-gray-700 mb-1">ID Pengguna</label>
                        <input type="text" id="login-id" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500" required>
                    </div>
                    <div class="mb-6">
                        <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">Kata Sandi</label>
                        <input type="password" id="login-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500" required>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition-colors">Login</button>
                    <p id="login-error" class="text-red-500 text-sm text-center mt-4"></p>
                </form>
                 <button id="login-to-welcome-btn" class="w-full text-center text-gray-600 mt-6 hover:underline">Kembali ke Halaman Awal</button>
            </div>
        </div>
    </div>
    
    <!-- Tampilan Login Admin -->
    <div id="admin-login-view" class="hidden">
        <div class="min-h-screen flex items-center justify-center bg-gray-100">
            <div class="max-w-md w-full bg-white p-8 rounded-2xl shadow-lg">
                <div class="text-center mb-8">
                    <h1 class="text-3xl font-bold text-gray-800">Login Admin</h1>
                    <p class="text-gray-500 mt-2">Masukkan kata sandi untuk mengakses daftar pesanan.</p>
                </div>
                <form id="admin-login-form">
                    <div class="mb-6">
                        <label for="admin-password" class="block text-sm font-medium text-gray-700 mb-1">Kata Sandi</label>
                        <input type="password" id="admin-password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-amber-500" required>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition-colors">Masuk</button>
                    <p id="admin-login-error" class="text-red-500 text-sm text-center mt-4"></p>
                </form>
                 <button id="admin-login-to-welcome-btn" class="w-full text-center text-gray-600 mt-6 hover:underline">Kembali ke Halaman Awal</button>
            </div>
        </div>
    </div>

    <!-- Tampilan Pelanggan -->
    <div id="customer-view" class="hidden">
        <div class="bg-amber-50">
            <div class="container mx-auto max-w-4xl pb-32">
                <header class="relative">
                    <img src="https://cdn.rri.co.id/berita/Madiun/o/1721375014670-62506-martabak-manis-vs-martabak-telor-62a5e327bb44867afb794a52/cli9prc4mtupb9d.jpeg" 
                         alt="[Gambar aneka martabak manis]" 
                         class="w-full h-48 md:h-64 object-cover rounded-b-2xl shadow-lg">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent rounded-b-2xl"></div>
                    <div class="absolute top-4 right-4 flex gap-2">
                        <button id="to-tracking-btn" class="bg-white/20 backdrop-blur-sm text-white font-semibold py-2 px-4 rounded-lg hover:bg-white/30 transition-colors flex items-center gap-2">
                            <span id="status-indicator-dot" class="w-3 h-3 rounded-full bg-gray-400"></span>
                            Status Pesanan
                        </button>
                        <button id="customer-logout-btn" class="bg-red-500/50 backdrop-blur-sm text-white p-3 rounded-lg hover:bg-red-500/70 transition-colors" title="Logout">
                            <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0 0 13.5 3h-6a2.25 2.25 0 0 0-2.25 2.25v13.5A2.25 2.25 0 0 0 7.5 21h6a2.25 2.25 0 0 0 2.25-2.25V15m3 0 3-3m0 0-3-3m3 3H9" /></svg>
                        </button>
                    </div>
                    <div class="absolute bottom-4 left-4 text-white">
                        <h1 class="text-3xl font-bold">Martabak Ayesha</h1>
                        <p class="text-sm">‚≠ê 4.8 | Jl. A. Yani, Seberang Rocket Chicken 2 Puruk Cahu</p>
                    </div>
                </header>
                <main class="px-4 py-6" id="menu-container">
                    <section id="martabak-manis" class="mb-8"><h2 class="text-2xl font-bold text-gray-800 mb-4">Terang Bulan</h2><div id="martabak-manis-list" class="grid grid-cols-1 gap-4"></div></section>
                    <section id="martabak-telur"><h2 class="text-2xl font-bold text-gray-800 mb-4">Martabak Telur</h2><div id="martabak-telur-list" class="grid grid-cols-1 gap-4"></div></section>
                </main>
            </div>
            <footer id="cart-summary" class="fixed bottom-0 left-0 right-0 bg-white border-t border-gray-200 p-4 shadow-[0_-2px_10px_rgba(0,0,0,0.1)] transform translate-y-full">
                <div class="container mx-auto max-w-4xl"><div id="cart-content"></div><div class="flex justify-between items-center mt-4"><div><p class="text-sm text-gray-500">Total Pembayaran</p><p id="cart-total" class="text-xl font-bold text-gray-900">Rp 0</p></div><button id="checkout-button" class="bg-green-600 text-white font-bold py-3 px-8 rounded-full hover:bg-green-700 disabled:bg-gray-400">Pesan Sekarang</button></div></div>
            </footer>
        </div>
    </div>

    <!-- Tampilan Admin (Staf) -->
    <div id="admin-view" class="hidden">
        <div class="container mx-auto p-4 md:p-8">
            <header class="mb-8 text-center relative">
                <button id="admin-to-welcome-btn" class="absolute top-4 left-4 bg-white p-3 rounded-full shadow-lg hover:bg-gray-200 transition-colors" title="Kembali ke Halaman Awal"><svg class="h-6 w-6 text-gray-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg></button>
                <h1 class="text-4xl font-bold text-gray-800">Daftar Pesanan Masuk</h1>
                <p class="text-gray-600 mt-2">Pesanan akan diperbarui secara real-time.</p>
            </header>
            <main id="orders-container" class="max-w-2xl mx-auto grid grid-cols-1 gap-6"></main>
        </div>
    </div>
    
    <!-- Tampilan Status Pesanan -->
    <div id="tracking-view" class="hidden">
        <div id="status-notification" class="hidden fixed top-5 right-5 z-50 text-white p-4 rounded-lg shadow-lg flex items-center gap-4">
            <span id="status-notification-message"></span>
            <button id="close-notification-btn" class="font-bold text-xl">&times;</button>
        </div>
        <div class="container mx-auto p-4 md:p-8">
            <header class="mb-8 text-center relative">
                <button id="tracking-to-customer-btn" class="absolute top-4 left-4 bg-white p-3 rounded-full shadow-lg hover:bg-gray-200 transition-colors"><svg class="h-6 w-6 text-gray-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg></button>
                <h1 class="text-4xl font-bold text-gray-800">Status Pesanan Anda</h1>
                <p class="text-gray-600 mt-2">Status pesanan terakhir Anda.</p>
            </header>
            <main class="max-w-2xl mx-auto" id="order-status-container"></main>
        </div>
    </div>
    
    <!-- Tampilan Dasbor Bos -->
    <div id="boss-dashboard-view" class="hidden">
        <div class="container mx-auto p-4 md:p-8">
            <header class="mb-8 text-center relative">
                 <button id="boss-dashboard-to-welcome-btn" class="absolute top-4 left-4 bg-white p-3 rounded-full shadow-lg hover:bg-gray-200 transition-colors" title="Kembali ke Halaman Awal">
                    <svg class="h-6 w-6 text-gray-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg>
                 </button>
                <h1 class="text-4xl font-bold text-gray-800">Dasbor Bos</h1>
                <p class="text-gray-600 mt-2">Pusat kendali dan laporan.</p>
            </header>
            <main class="max-w-xl mx-auto grid grid-cols-1 md:grid-cols-2 gap-6">
                <button id="dashboard-to-report-btn" class="bg-white p-6 rounded-xl shadow-md text-center hover:bg-gray-50 transition-colors">
                    <h2 class="text-2xl font-bold text-gray-800">Laporan Penjualan</h2>
                    <p class="text-gray-500 mt-1">Analisis data penjualan.</p>
                </button>
                <button id="dashboard-to-settings-btn" class="bg-white p-6 rounded-xl shadow-md text-center hover:bg-gray-50 transition-colors">
                    <h2 class="text-2xl font-bold text-gray-800">Pengaturan Admin</h2>
                    <p class="text-gray-500 mt-1">Kelola kata sandi admin.</p>
                </button>
                <button id="dashboard-to-customers-btn" class="bg-white p-6 rounded-xl shadow-md text-center hover:bg-gray-50 transition-colors">
                    <h2 class="text-2xl font-bold text-gray-800">Data Pelanggan</h2>
                    <p class="text-gray-500 mt-1">Lihat daftar pelanggan.</p>
                </button>
                <button id="dashboard-reset-btn" class="bg-red-100 text-red-700 p-6 rounded-xl shadow-md text-center hover:bg-red-200 transition-colors">
                    <h2 class="text-2xl font-bold">Reset Penjualan</h2>
                    <p class="mt-1">Hapus semua data pesanan selesai.</p>
                </button>
            </main>
        </div>
    </div>

    <!-- Tampilan Laporan -->
    <div id="report-view" class="hidden"><div class="container mx-auto p-4 md:p-8"><header class="mb-8 text-center relative"><button id="report-to-dashboard-btn" class="absolute top-4 left-4 bg-white p-3 rounded-full shadow-lg hover:bg-gray-200 transition-colors"><svg class="h-6 w-6 text-gray-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" /></svg></button><h1 class="text-4xl font-bold text-gray-800">Laporan Penjualan</h1><p class="text-gray-600 mt-2">Ringkasan penjualan dari pesanan yang selesai.</p></header><main><div class="flex justify-center gap-2 mb-8" id="report-filter-buttons"><button data-filter="today" class="report-filter-btn bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg">Hari Ini</button><button data-filter="month" class="report-filter-btn bg-white text-gray-700 font-semibold py-2 px-4 rounded-lg">Bulan Ini</button><button data-filter="all" class="report-filter-btn bg-white text-gray-700 font-semibold py-2 px-4 rounded-lg">Semua</button></div><div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8"><div class="bg-white p-6 rounded-xl shadow-md text-center"><p class="text-sm text-gray-500">Total Penjualan</p><p id="report-total-revenue" class="text-3xl font-bold text-gray-900">Rp 0</p></div><div class="bg-white p-6 rounded-xl shadow-md text-center"><p class="text-sm text-gray-500">Pesanan Selesai</p><p id="report-total-orders" class="text-3xl font-bold text-gray-900">0</p></div><div class="bg-white p-6 rounded-xl shadow-md text-center"><p class="text-sm text-gray-500">Item Terjual</p><p id="report-total-items" class="text-3xl font-bold text-gray-900">0</p></div></div><div class="bg-white p-6 rounded-xl shadow-md"><h2 class="text-xl font-bold text-gray-800 mb-4">Rincian Item Terjual</h2><div id="report-item-breakdown" class="space-y-6"></div></div></main></div></div>

    <!-- Tampilan Pengaturan -->
    <div id="settings-view" class="hidden">
        <div class="container mx-auto p-4 md:p-8">
            <header class="mb-8 text-center relative">
                 <button id="settings-to-dashboard-btn" class="absolute top-4 left-4 bg-white p-3 rounded-full shadow-lg hover:bg-gray-200 transition-colors">
                    <svg class="h-6 w-6 text-gray-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                </button>
                <h1 class="text-4xl font-bold text-gray-800">Pengaturan Admin</h1>
                <p class="text-gray-600 mt-2">Atur kata sandi untuk akses halaman admin.</p>
            </header>
            <main class="max-w-lg mx-auto bg-white p-8 rounded-xl shadow-md">
                <form id="admin-password-form">
                    <div class="mb-6">
                        <label for="new-admin-password" class="block text-sm font-medium text-gray-700 mb-1">Kata Sandi Admin Baru</label>
                        <input type="password" id="new-admin-password" placeholder="Minimal 6 karakter" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" required>
                    </div>
                    <button type="submit" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition-colors">Simpan Kata Sandi</button>
                    <p id="settings-success" class="text-green-600 text-sm text-center mt-4"></p>
                </form>
            </main>
        </div>
    </div>
    
    <!-- Tampilan Data Pelanggan -->
     <div id="customers-view" class="hidden">
        <div class="container mx-auto p-4 md:p-8">
            <header class="mb-8 text-center relative">
                 <button id="customers-to-dashboard-btn" class="absolute top-4 left-4 bg-white p-3 rounded-full shadow-lg hover:bg-gray-200 transition-colors">
                    <svg class="h-6 w-6 text-gray-700" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M10 19l-7-7m0 0l7-7m-7 7h18" />
                    </svg>
                </button>
                <h1 class="text-4xl font-bold text-gray-800">Data Pelanggan</h1>
                <p class="text-gray-600 mt-2">Daftar semua pelanggan yang pernah memesan.</p>
            </header>
            <main class="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-md">
                <div class="mb-4">
                    <input type="search" id="customer-search-input" placeholder="Cari berdasarkan nomor WhatsApp..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nama</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">No. WhatsApp</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="customers-list" class="bg-white divide-y divide-gray-200">
                            <!-- Data pelanggan akan dirender di sini -->
                        </tbody>
                    </table>
                </div>
            </main>
        </div>
    </div>
    
    <!-- Tampilan Struk -->
    <div id="receipt-view" class="hidden">
        <div class="flex flex-col items-center p-4 bg-gray-200 min-h-screen">
            <div id="receipt-paper" class="w-full max-w-sm bg-white p-6 text-black text-sm shadow-lg" data-total="0">
                <!-- Konten struk akan dirender di sini -->
            </div>
            <div id="receipt-controls" class="mt-6 w-full max-w-sm">
                <div class="flex gap-2 mb-4">
                     <input type="number" id="cash-input" placeholder="Uang Bayar (Opsional)" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                     <button id="calculate-change-btn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-4 rounded-lg hover:bg-gray-300">Hitung</button>
                </div>
                <div class="flex gap-4">
                    <button id="receipt-to-admin-btn" class="bg-gray-500 text-white font-semibold py-2 px-6 rounded-lg w-full">Kembali</button>
                    <button id="print-receipt-btn" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg w-full">Cetak Struk</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Modals -->
    <div id="order-confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50"><div class="bg-white p-8 rounded-2xl shadow-xl text-center max-w-sm mx-4"><h3 class="text-2xl font-bold">Konfirmasi Pesanan</h3><p class="text-gray-600 mt-2 mb-6">Lanjutkan pesanan ini?</p><div class="flex justify-center gap-4"><button id="review-order-btn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300">Periksa</button><button id="confirm-order-btn" class="bg-green-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-green-700">OK</button></div></div></div>
    <div id="success-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50"><div class="bg-white p-8 rounded-2xl shadow-xl text-center max-w-sm mx-4"><div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 mb-4"><svg class="h-10 w-10 text-green-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg></div><h3 class="text-2xl font-bold">Pesanan Diterima!</h3><p id="success-message" class="text-gray-600 mt-2 mb-6"></p><button id="close-success-modal-btn" class="bg-green-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-green-700">Tutup</button></div></div>
    <div id="reset-confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50"><div class="bg-white p-8 rounded-2xl shadow-xl text-center max-w-sm mx-4"><h3 class="text-2xl font-bold text-red-600">Reset Penjualan?</h3><p class="text-gray-600 mt-2 mb-6">Tindakan ini akan menghapus SEMUA data pesanan yang telah selesai dan tidak dapat dibatalkan. Yakin ingin melanjutkan?</p><div class="flex justify-center gap-4"><button id="cancel-reset-btn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300">Batal</button><button id="confirm-reset-btn" class="bg-red-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-red-700">Ya, Reset</button></div></div></div>
    <div id="name-mismatch-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50"><div class="bg-white p-8 rounded-2xl shadow-xl text-center max-w-sm mx-4"><h3 class="text-2xl font-bold text-yellow-600">Nama Berbeda</h3><p class="text-gray-600 mt-2 mb-6" id="name-mismatch-message"></p><div class="flex justify-center gap-4"><button id="cancel-mismatch-btn" class="bg-gray-200 text-gray-800 font-semibold py-2 px-6 rounded-lg hover:bg-gray-300">Batal</button><button id="confirm-mismatch-btn" class="bg-green-600 text-white font-semibold py-2 px-6 rounded-lg hover:bg-green-700">Gunakan Nama Lama</button></div></div></div>


    <script type="module">
        // --- Firebase SDK Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, doc, updateDoc, addDoc, getDoc, getDocs, serverTimestamp, where, query, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Initialization ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const ordersCollectionRef = collection(db, `artifacts/${appId}/public/data/orders`);
        const adminConfigDocRef = doc(db, `artifacts/${appId}/public/data/app_config`, 'admin_access');
        const customersCollectionRef = collection(db, `artifacts/${appId}/public/data/customers`);

        // --- Global State & Data ---
        let cart = [], unsubscribeOrderStatus = null, allCompletedOrders = [], allOrdersCache = [], allCustomersCache = [];
        const menuData = [
            { id: 1, name: 'Susu Original', category: 'manis', price: 10000, description: 'Klasik dan manis.', image: 'https://i0.wp.com/makanmana.net/wp-content/uploads/2019/03/P1230015.jpg?w=1200&ssl=1' },
            { id: 2, name: 'Kacang Susu', category: 'manis', price: 15000, description: 'Kacang renyah dan susu.', image: 'https://mykitchen101en.com/wp-content/uploads/2018/11/apambalik11tn.jpg' },
            { id: 3, name: 'Coklat Susu', category: 'manis', price: 15000, description: 'Cokelat premium dan susu.', image: 'https://www.redaksiku.com/wp-content/uploads/2024/11/IMG_20241101_090639.jpg' },
            { id: 4, name: 'Kacang Coklat Susu', category: 'manis', price: 20000, description: 'Kacang dan cokelat.', image: 'https://syl140985.wordpress.com/wp-content/uploads/2018/10/201810312059061305719679.jpg' },
            { id: 5, name: 'Keju Susu', category: 'manis', price: 20000, description: 'Keju cheddar dan susu.', image: 'https://i.ytimg.com/vi/zajmxLEdVk4/maxresdefault.jpg' },
            { id: 6, name: 'Keju Kacang Susu', category: 'manis', price: 25000, description: 'Keju dan kacang.', image: 'https://radarpena.disway.id/upload/09cd5c659a4a2d810f54554a2d01ee28.jpg' },
            { id: 7, name: 'Keju Coklat Susu', category: 'manis', price: 25000, description: 'Keju dan cokelat.', image: 'https://i.gojekapi.com/darkroom/gofood-indonesia/v2/images/uploads/799e4206-d3db-49ce-b0ca-e39986fa3316_file20190412-24755-bqxxqe.jpeg' },
            { id: 8, name: 'Komplit', category: 'manis', price: 30000, description: 'Kacang, cokelat, dan keju.', image: 'https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcS23yFvaXZv5VCH4zLVykopH4jS515orD70bQ&s' },
            { id: 9, name: 'Martabak Telur Biasa', category: 'telur', price: 20000, description: 'Telur ayam dan daun bawang.', image: 'https://assets.promediateknologi.id/crop/0x0:0x0/750x500/webp/photo/2022/08/29/212431068.jpg' },
            { id: 10, name: 'Martabak Telur Spesial', category: 'telur', price: 40000, description: 'Telur bebek, daging ayam.', image: 'https://assets.promediateknologi.id/crop/0x0:0x0/750x500/webp/photo/2022/08/29/212431068.jpg' },
            { id: 11, name: 'Martabak Telur Istimewa', category: 'telur', price: 60000, description: 'Telur bebek, daging sapi.', image: 'https://assets.promediateknologi.id/crop/0x0:0x0/750x500/webp/photo/2022/08/29/212431068.jpg' }
        ];

        // --- DOM Elements ---
        const allViews = {
            welcome: document.getElementById('welcome-view'),
            customer_login: document.getElementById('customer-login-view'),
            login: document.getElementById('login-view'),
            admin_login: document.getElementById('admin-login-view'),
            customer: document.getElementById('customer-view'),
            admin: document.getElementById('admin-view'),
            tracking: document.getElementById('tracking-view'),
            boss_dashboard: document.getElementById('boss-dashboard-view'),
            report: document.getElementById('report-view'),
            settings: document.getElementById('settings-view'),
            customers: document.getElementById('customers-view'),
            receipt: document.getElementById('receipt-view')
        };
        const manisList = document.getElementById('martabak-manis-list'), telurList = document.getElementById('martabak-telur-list'), cartSummary = document.getElementById('cart-summary'), cartContent = document.getElementById('cart-content'), cartTotalEl = document.getElementById('cart-total'), checkoutButton = document.getElementById('checkout-button');
        const ordersContainer = document.getElementById('orders-container'), orderStatusContainer = document.getElementById('order-status-container');
        const loginForm = document.getElementById('login-form'), loginError = document.getElementById('login-error');
        const adminLoginForm = document.getElementById('admin-login-form'), adminLoginError = document.getElementById('admin-login-error');
        const adminPasswordForm = document.getElementById('admin-password-form'), settingsSuccess = document.getElementById('settings-success');
        const orderConfirmationModal = document.getElementById('order-confirmation-modal'), reviewOrderBtn = document.getElementById('review-order-btn'), confirmOrderBtn = document.getElementById('confirm-order-btn'), successModal = document.getElementById('success-modal'), successMessage = document.getElementById('success-message'), closeSuccessModalBtn = document.getElementById('close-success-modal-btn');
        const reportTotalRevenue = document.getElementById('report-total-revenue'), reportTotalOrders = document.getElementById('report-total-orders'), reportTotalItems = document.getElementById('report-total-items'), reportItemBreakdown = document.getElementById('report-item-breakdown'), reportFilterButtons = document.getElementById('report-filter-buttons');
        const resetConfirmationModal = document.getElementById('reset-confirmation-modal');
        const receiptPaper = document.getElementById('receipt-paper');
        const adminNotificationBadge = document.getElementById('admin-notification-badge');
        const customersList = document.getElementById('customers-list');
        const customerSearchInput = document.getElementById('customer-search-input');
        const nameMismatchModal = document.getElementById('name-mismatch-modal');
        const statusNotification = document.getElementById('status-notification');
        const statusNotificationMessage = document.getElementById('status-notification-message');
        const statusIndicatorDot = document.getElementById('status-indicator-dot');

        // --- Functions ---
        const formatCurrency = (n) => new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(n);

        const switchView = (viewName) => {
            Object.values(allViews).forEach(v => v.classList.add('hidden'));
            if (unsubscribeOrderStatus) { unsubscribeOrderStatus(); unsubscribeOrderStatus = null; }

            if (allViews[viewName]) {
                allViews[viewName].classList.remove('hidden');
                if (viewName === 'tracking') displayLastOrderStatus();
                if (viewName === 'report') generateReport('today');
                if (viewName === 'admin') {
                    const badge = document.getElementById('admin-notification-badge');
                    if(badge) badge.classList.add('hidden');
                }
                if (viewName === 'customers') loadCustomers();
            } else {
                allViews.customer.classList.remove('hidden');
            }
        };
        
        const renderMenu = () => {
            manisList.innerHTML = ''; telurList.innerHTML = '';
            menuData.forEach(item => {
                const listContainer = item.category === 'manis' ? manisList : telurList;
                listContainer.innerHTML += `<div class="bg-white rounded-xl shadow-md overflow-hidden flex"><img class="h-32 w-40 object-cover" src="${item.image}" onerror="this.onerror=null;this.src='https://placehold.co/400x300/e2e8f0/64748b?text=Martabak';"><div class="p-4 flex flex-col flex-grow"><h3 class="font-bold text-lg">${item.name}</h3><p class="text-sm text-gray-600 mt-1 flex-grow">${item.description}</p><div class="flex justify-between items-center mt-3"><p class="font-semibold">${formatCurrency(item.price)}</p><button data-id="${item.id}" class="add-to-cart-btn bg-green-100 text-green-800 font-bold text-sm px-4 py-2 rounded-full hover:bg-green-200">Tambah</button></div></div></div>`;
            });
        };
        
        const renderCart = () => {
            if (cart.length === 0) { cartSummary.classList.remove('cart-slide-up'); checkoutButton.disabled = true; return; }
            cartSummary.classList.add('cart-slide-up');
            cartContent.innerHTML = '';
            let total = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
            cart.forEach(item => {
                cartContent.innerHTML += `<div class="flex justify-between items-center mb-2"><div class="flex-grow"><p class="font-semibold">${item.name}</p><p class="text-sm text-gray-600">${formatCurrency(item.price)}</p></div><div class="flex items-center gap-2"><button data-id="${item.id}" class="decrease-quantity-btn bg-gray-200 w-7 h-7 rounded-full font-bold">-</button><span class="font-semibold w-5 text-center">${item.quantity}</span><button data-id="${item.id}" class="increase-quantity-btn bg-gray-200 w-7 h-7 rounded-full font-bold">+</button></div></div>`;
            });
            cartTotalEl.textContent = formatCurrency(total);
            checkoutButton.disabled = false;
        };
        
        const modifyCart = (id, change) => {
            const itemIndex = cart.findIndex(item => item.id === id);
            if (itemIndex > -1) { cart[itemIndex].quantity += change; if (cart[itemIndex].quantity === 0) cart.splice(itemIndex, 1); }
            else if (change === 1) cart.push({ ...menuData.find(item => item.id === id), quantity: 1 });
            renderCart();
        };

        const renderOrders = (orders) => {
            allOrdersCache = orders; // Cache for receipt generation
            ordersContainer.innerHTML = ''; 
            if (orders.length === 0) { ordersContainer.innerHTML = `<div class="col-span-full text-center py-12"><p class="text-gray-500">Belum ada pesanan.</p></div>`; return; }
            orders.sort((a, b) => a.queueNumber - b.queueNumber).forEach(order => {
                let statusBadgeClass = 'text-blue-600 bg-blue-100';
                if (order.status === 'Selesai') statusBadgeClass = 'text-green-600 bg-green-100';
                if (order.status === 'Diproses') statusBadgeClass = 'text-yellow-600 bg-yellow-100';
                const isMasuk = order.status === 'Masuk', isDiproses = order.status === 'Diproses', isSelesai = order.status === 'Selesai';
                const itemsHTML = order.items.map(item => `<li class="flex justify-between text-sm"><span>${item.quantity}x ${item.name}</span><span class="font-medium">${formatCurrency(item.price * item.quantity)}</span></li>`).join('');
                const customerInfo = order.customerName ? `<p class="text-sm text-gray-500 mt-1">${order.customerName} (${order.customerWhatsapp})</p>` : '';
                ordersContainer.innerHTML += `<div class="order-card-enter rounded-2xl shadow-lg overflow-hidden border ${isSelesai ? 'bg-green-50' : 'bg-white'} flex flex-col"><div class="p-5"><div class="flex justify-between items-baseline mb-2"><h2 class="text-xl font-bold">#${order.queueNumber}</h2><span class="font-semibold px-3 py-1 text-xs rounded-full ${statusBadgeClass}">${order.status}</span></div>${customerInfo}<ul class="space-y-2 border-t border-b py-3 my-3">${itemsHTML}</ul><div class="flex justify-between items-center"><span class="font-medium">Total:</span><span class="text-lg font-bold">${formatCurrency(order.total)}</span></div></div><div class="mt-auto p-3 bg-gray-50 flex gap-2"><button data-id="${order.id}" data-status="Diproses" class="update-status-btn w-full bg-yellow-500 text-white font-semibold py-2 rounded-lg hover:bg-yellow-600 ${!isMasuk ? 'hidden' : ''}">Diproses</button><button data-id="${order.id}" data-status="Selesai" class="update-status-btn w-full bg-green-500 text-white font-semibold py-2 rounded-lg hover:bg-green-600 disabled:bg-green-300 disabled:cursor-not-allowed ${!isDiproses && !isSelesai ? 'hidden' : ''}" ${isSelesai ? 'disabled' : ''}>Selesai</button></div></div>`;
            });
        };
        
        const generateAndShowReceipt = (orderId) => {
            const order = allOrdersCache.find(o => o.id === orderId);
            if (!order) return;
            
            receiptPaper.dataset.total = order.total;
            const date = order.createdAt ? order.createdAt.toDate() : new Date();
            const formattedDate = `${date.toLocaleDateString('id-ID')} ${date.toLocaleTimeString('id-ID')}`;
            
            let itemsHTML = '';
            order.items.forEach(item => {
                const itemTotal = formatCurrency(item.price * item.quantity).padStart(10);
                itemsHTML += `
                    <div>${item.name}</div>
                    <div class="flex justify-between">
                        <span>${item.quantity} x ${formatCurrency(item.price)}</span>
                        <span>${itemTotal}</span>
                    </div>
                `;
            });

            receiptPaper.innerHTML = `
                <div class="text-center">
                    <h2 class="text-xl font-bold">Martabak Ayesha</h2>
                    <p>Jl. A. Yani, Puruk Cahu</p>
                    <p>--------------------------------</p>
                </div>
                <div>
                    <p>No: #${order.queueNumber}</p>
                    <p>Waktu: ${formattedDate}</p>
                    <p>Pelanggan: ${order.customerName || 'N/A'}</p>
                    <p>--------------------------------</p>
                </div>
                <div class="space-y-2">
                    ${itemsHTML}
                </div>
                <p>--------------------------------</p>
                <div class="flex justify-between font-bold text-lg">
                    <span>TOTAL</span>
                    <span>${formatCurrency(order.total)}</span>
                </div>
                <div id="payment-details" class="hidden mt-2 pt-2 border-t border-dashed border-black">
                    <div class="flex justify-between">
                        <span>Bayar</span>
                        <span id="receipt-cash"></span>
                    </div>
                    <div class="flex justify-between">
                        <span>Kembali</span>
                        <span id="receipt-change"></span>
                    </div>
                </div>
                <div class="text-center mt-6">
                    <p>Terima Kasih!</p>
                    <p>Silakan datang kembali.</p>
                </div>
            `;
            document.getElementById('cash-input').value = '';
            switchView('receipt');
        };

        const displayLastOrderStatus = () => {
            const customerData = JSON.parse(localStorage.getItem('customerData'));
            if (!customerData) {
                orderStatusContainer.innerHTML = `<div class="text-center bg-white p-8 rounded-xl shadow-md"><p class="text-gray-500">Anda harus login untuk melihat status pesanan.</p></div>`;
                return;
            }
            orderStatusContainer.innerHTML = `<div class="text-center bg-white p-8 rounded-xl shadow-md"><p class="text-gray-500">Mencari pesanan terakhir Anda...</p></div>`;
            
            const q = query(ordersCollectionRef, where("customerWhatsapp", "==", customerData.whatsapp));
            let currentStatus = '';

            unsubscribeOrderStatus = onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    orderStatusContainer.innerHTML = `<div class="text-center bg-white p-8 rounded-xl shadow-md"><p class="text-gray-500">Anda belum memiliki pesanan.</p></div>`;
                    return;
                }
                const userOrders = snapshot.docs.map(doc => ({id: doc.id, ...doc.data()}));
                userOrders.sort((a,b) => b.createdAt.seconds - a.createdAt.seconds);
                const lastOrder = userOrders[0];

                if (currentStatus && currentStatus !== lastOrder.status) {
                    let message = '';
                    let bgColor = '';
                    let soundNote = '';
                    if (lastOrder.status === 'Diproses') {
                        message = 'Pesanan Anda sedang diproses!';
                        bgColor = 'bg-yellow-500';
                        soundNote = 'E5';
                    } else if (lastOrder.status === 'Selesai') {
                        message = 'Pesanan Anda sudah selesai!';
                        bgColor = 'bg-green-500';
                        soundNote = 'G5';
                    }
                    if (message) {
                        statusNotificationMessage.textContent = message;
                        statusNotification.className = `fixed top-5 right-5 z-50 text-white p-4 rounded-lg shadow-lg flex items-center gap-4 ${bgColor}`;
                        statusNotification.classList.remove('hidden');
                        if (Tone.context.state === 'running') {
                            const synth = new Tone.Synth().toDestination();
                            synth.triggerAttackRelease(soundNote, "8n");
                        }
                    }
                }
                currentStatus = lastOrder.status;

                let statusBadgeClass = 'text-blue-600 bg-blue-100';
                let indicatorDotClass = 'bg-blue-500';
                if (lastOrder.status === 'Selesai') {
                     statusBadgeClass = 'text-green-600 bg-green-100';
                     indicatorDotClass = 'bg-green-500';
                }
                if (lastOrder.status === 'Diproses') {
                    statusBadgeClass = 'text-yellow-600 bg-yellow-100';
                    indicatorDotClass = 'bg-yellow-500';
                }
                statusIndicatorDot.className = `w-3 h-3 rounded-full ${indicatorDotClass}`;

                const itemsHTML = lastOrder.items.map(item => `<li class="flex justify-between text-gray-700"><span>${item.quantity}x ${item.name}</span><span>${formatCurrency(item.price * item.quantity)}</span></li>`).join('');
                orderStatusContainer.innerHTML = `<div class="bg-white p-6 rounded-xl shadow-md text-left"><div class="flex justify-between items-center pb-4 border-b"><div><p class="text-sm text-gray-500">Nomor Antrian</p><p class="text-2xl font-bold">#${lastOrder.queueNumber}</p></div><div class="text-right"><p class="text-sm text-gray-500">Status</p><span class="font-bold text-lg px-4 py-1 mt-1 inline-block rounded-full ${statusBadgeClass}">${lastOrder.status}</span></div></div><div class="py-4"><h4 class="font-semibold mb-2">Detail Pesanan:</h4><ul class="space-y-1">${itemsHTML}</ul></div><div class="flex justify-between items-center pt-4 border-t"><span class="font-semibold">Total Pembayaran</span><span class="font-bold text-xl">${formatCurrency(lastOrder.total)}</span></div></div>`;
            });
        };

        const generateReport = (filter) => {
            const filteredOrders = allCompletedOrders.filter(order => {
                if (!order.createdAt) return false;
                const orderDate = order.createdAt.toDate();
                const now = new Date();
                if (filter === 'today') return orderDate.toDateString() === now.toDateString();
                if (filter === 'month') return orderDate.getMonth() === now.getMonth() && orderDate.getFullYear() === now.getFullYear();
                return true;
            });

            const totalRevenue = filteredOrders.reduce((sum, order) => sum + order.total, 0);
            const totalOrders = filteredOrders.length;
            const totalItems = filteredOrders.reduce((sum, order) => sum + order.items.reduce((itemSum, item) => itemSum + item.quantity, 0), 0);
            
            const breakdown = filteredOrders.flatMap(order => order.items).reduce((acc, item) => {
                const menuItem = menuData.find(m => m.name === item.name);
                const category = menuItem ? menuItem.category : 'unknown';
                if (!acc[category]) acc[category] = { items: {}, subtotal: 0 };
                if (!acc[category].items[item.name]) acc[category].items[item.name] = { quantity: 0, revenue: 0 };
                acc[category].items[item.name].quantity += item.quantity;
                acc[category].items[item.name].revenue += item.quantity * item.price;
                acc[category].subtotal += item.quantity * item.price;
                return acc;
            }, {});

            reportTotalRevenue.textContent = formatCurrency(totalRevenue);
            reportTotalOrders.textContent = totalOrders;
            reportTotalItems.textContent = totalItems;
            
            reportItemBreakdown.innerHTML = '';
            const renderCategory = (category, title) => {
                if (breakdown[category] && Object.keys(breakdown[category].items).length > 0) {
                    let categoryHTML = `<h3 class="text-lg font-semibold text-gray-700 mt-4 mb-2">${title}</h3><ul class="space-y-2">`;
                    const sortedItems = Object.entries(breakdown[category].items).sort(([,a],[,b]) => b.revenue - a.revenue);
                    sortedItems.forEach(([name, data]) => {
                        categoryHTML += `<li class="flex justify-between border-b pb-2"><span class="text-gray-700">${data.quantity}x ${name}</span><span class="font-semibold text-gray-900">${formatCurrency(data.revenue)}</span></li>`;
                    });
                    categoryHTML += `<li class="flex justify-between pt-2 mt-2 border-t-2 border-gray-300"><span class="font-bold text-gray-800">Subtotal ${title}</span><span class="font-bold text-lg text-gray-900">${formatCurrency(breakdown[category].subtotal)}</span></li></ul>`;
                    reportItemBreakdown.innerHTML += categoryHTML;
                }
            };

            renderCategory('manis', 'Terang Bulan');
            renderCategory('telur', 'Martabak Telur');

            if (reportItemBreakdown.innerHTML === '') reportItemBreakdown.innerHTML = `<p class="text-gray-500">Tidak ada data untuk periode ini.</p>`;
            
            document.querySelectorAll('.report-filter-btn').forEach(btn => { btn.classList.remove('bg-blue-500', 'text-white'); btn.classList.add('bg-white', 'text-gray-700'); });
            document.querySelector(`.report-filter-btn[data-filter="${filter}"]`).classList.add('bg-blue-500', 'text-white');
        };
        
        const loadCustomers = async () => {
            const querySnapshot = await getDocs(customersCollectionRef);
            allCustomersCache = querySnapshot.docs.map(doc => doc.data());
            renderCustomers(allCustomersCache);
        };

        const renderCustomers = (customers) => {
            customersList.innerHTML = '';
            if (customers.length === 0) {
                customersList.innerHTML = `<tr><td colspan="3" class="px-6 py-4 text-center text-gray-500">Tidak ada pelanggan yang cocok.</td></tr>`;
                return;
            }
            customers.forEach(customer => {
                let formattedWhatsapp = customer.whatsapp;
                if (typeof formattedWhatsapp === 'string' && formattedWhatsapp.startsWith('0')) {
                    formattedWhatsapp = '62' + formattedWhatsapp.substring(1);
                }
                customersList.innerHTML += `<tr><td class="px-6 py-4 whitespace-nowrap">${customer.name}</td><td class="px-6 py-4 whitespace-nowrap">${customer.whatsapp}</td><td class="px-6 py-4 whitespace-nowrap text-sm font-medium flex gap-3"><a href="https://wa.me/${formattedWhatsapp}" target="_blank" class="p-2 rounded-full bg-green-100 text-green-600 hover:bg-green-200 transition-colors" title="Chat via WhatsApp"><svg class="w-5 h-5" viewBox="0 0 24 24" fill="currentColor" xmlns="http://www.w3.org/2000/svg"><path d="M12.04 2C6.58 2 2.13 6.45 2.13 12c0 1.8.48 3.47 1.32 4.94L2 22l5.25-1.38c1.41.79 3.02 1.22 4.79 1.22h.01c5.46 0 9.91-4.45 9.91-9.91S17.5 2 12.04 2zM9.53 8.5c.21 0 .39.08.53.22.14.14.22.32.22.53v.14c-.01.21-.09.39-.23.54l-1.2 1.16c.2.35.45.68.75.98s.63.55.98.75l1.16-1.2c.14-.14.32-.23.54-.23h.14c.21 0 .39.08.53.22.14.14.22.32.22.53v1.55c0 .21-.08.39-.22.53-.14.14-.32.22-.53.22h-.14c-.23 0-.46-.04-.68-.11-.7-.25-1.36-.64-1.95-1.13s-1.07-1.07-1.42-1.72c-.17-.32-.28-.67-.34-1.02-.02-.15-.02-.3 0-.46v-.14c0-.21.08-.39.22-.53s.32-.22.53-.22h.14zm2.51 11.42h-.01c-1.63 0-3.18-.44-4.52-1.25l-.32-.19-3.36.88.89-3.28-.21-.34c-.88-1.41-1.35-3.02-1.35-4.71 0-4.83 3.94-8.77 8.77-8.77s8.77 3.94 8.77 8.77c0 4.84-3.93 8.78-8.77 8.78z"/></svg></a><a href="tel:${customer.whatsapp}" class="p-2 rounded-full bg-blue-100 text-blue-600 hover:bg-blue-200 transition-colors" title="Panggil"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg></a></td></tr>`;
            });
        };

        const main = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                
                let isInitialLoad = true;
                const synth = new Tone.Synth().toDestination();

                document.body.addEventListener('click', () => {
                    if (Tone.context.state !== 'running') {
                        Tone.start();
                    }
                }, { once: true });

                onSnapshot(ordersCollectionRef, (snapshot) => {
                    snapshot.docChanges().forEach((change) => {
                        const badge = document.getElementById('admin-notification-badge');
                        if (change.type === "added" && !isInitialLoad) {
                            if (Tone.context.state === 'running') {
                                try {
                                    synth.triggerAttackRelease("C5", "8n", Tone.now());
                                } catch (e) {
                                    console.error("Tone.js error:", e);
                                }
                            }
                            if (badge && document.getElementById('welcome-view').offsetParent !== null) {
                                badge.classList.remove('hidden');
                            }
                        }
                    });
                    isInitialLoad = false;

                    const allOrders = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    allCompletedOrders = allOrders.filter(order => order.status === 'Selesai');
                    renderOrders(allOrders);
                });

                document.body.addEventListener('click', async (e) => {
                    const target = e.target.closest('button');
                    if (!target) return;

                    const id = target.dataset.id;
                    // Customer View
                    if (target.matches('.add-to-cart-btn')) modifyCart(parseInt(id), 1);
                    if (target.matches('.increase-quantity-btn')) modifyCart(parseInt(id), 1);
                    if (target.matches('.decrease-quantity-btn')) modifyCart(parseInt(id), -1);
                    if (target.id === 'checkout-button') orderConfirmationModal.classList.remove('hidden');
                    if (target.id === 'review-order-btn') orderConfirmationModal.classList.add('hidden');
                    if (target.id === 'close-success-modal-btn') { successModal.classList.add('hidden'); cart = []; renderCart(); }
                    // Admin View
                    if (target.matches('.update-status-btn')) {
                        if (id && !target.disabled) {
                            await updateDoc(doc(db, `artifacts/${appId}/public/data/orders`, id), { status: target.dataset.status });
                            if (target.dataset.status === 'Selesai') {
                                generateAndShowReceipt(id);
                            }
                        }
                    }
                    // Navigation
                    if (target.id === 'welcome-to-customer-login-btn') {
                        if (localStorage.getItem('customerData')) {
                            switchView('customer');
                        } else {
                            switchView('customer_login');
                        }
                    }
                    if (target.id === 'welcome-to-admin-login-btn') switchView('admin_login');
                    if (target.id === 'welcome-to-boss-login-btn') switchView('login');
                    if (target.id === 'login-to-welcome-btn' || target.id === 'admin-login-to-welcome-btn' || target.id === 'admin-to-welcome-btn' || target.id === 'boss-dashboard-to-welcome-btn') switchView('welcome');
                    if (target.id === 'customer-logout-btn') { localStorage.removeItem('customerData'); switchView('welcome'); }
                    if (target.id === 'to-tracking-btn') switchView('tracking');
                    if (target.id === 'tracking-to-customer-btn') switchView('customer');
                    if (target.id === 'dashboard-to-admin-btn') switchView('admin');
                    if (target.id === 'dashboard-to-report-btn') switchView('report');
                    if (target.id === 'dashboard-to-settings-btn') switchView('settings');
                    if (target.id === 'dashboard-to-customers-btn') switchView('customers');
                    if (target.id === 'report-to-dashboard-btn' || target.id === 'settings-to-dashboard-btn' || target.id === 'customers-to-dashboard-btn') switchView('boss_dashboard');
                    if (target.id === 'dashboard-reset-btn') resetConfirmationModal.classList.remove('hidden');
                    if (target.id === 'cancel-reset-btn') resetConfirmationModal.classList.add('hidden');
                    if (target.id === 'receipt-to-admin-btn') switchView('admin');
                    if (target.id === 'print-receipt-btn') window.print();
                    if (target.id === 'calculate-change-btn') {
                        const cashInput = document.getElementById('cash-input');
                        const cashAmount = parseFloat(cashInput.value);
                        const totalAmount = parseFloat(receiptPaper.dataset.total);

                        if (!isNaN(cashAmount) && cashAmount >= totalAmount) {
                            const changeAmount = cashAmount - totalAmount;
                            document.getElementById('receipt-cash').textContent = formatCurrency(cashAmount);
                            document.getElementById('receipt-change').textContent = formatCurrency(changeAmount);
                            document.getElementById('payment-details').classList.remove('hidden');
                        } else {
                            document.getElementById('payment-details').classList.add('hidden');
                        }
                    }
                    if (target.id === 'cancel-mismatch-btn') nameMismatchModal.classList.add('hidden');
                    if (target.id === 'confirm-mismatch-btn') {
                        const customerData = JSON.parse(target.dataset.customer);
                        localStorage.setItem('customerData', JSON.stringify(customerData));
                        nameMismatchModal.classList.add('hidden');
                        switchView('customer');
                    }
                    if (target.id === 'close-notification-btn') statusNotification.classList.add('hidden');
                });

                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    loginError.textContent = '';
                    const userId = document.getElementById('login-id').value;
                    const password = document.getElementById('login-password').value;

                    if (userId === 'bos' && password === 'bos123') {
                        switchView('boss_dashboard');
                    } else {
                        loginError.textContent = 'ID atau Kata Sandi salah.';
                    }
                });

                adminLoginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    adminLoginError.textContent = '';
                    const password = document.getElementById('admin-password').value;
                    const docSnap = await getDoc(adminConfigDocRef);
                    if (docSnap.exists() && password === docSnap.data().password) {
                        switchView('admin');
                    } else {
                        adminLoginError.textContent = 'Kata Sandi salah.';
                    }
                });

                document.getElementById('admin-password-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const password = document.getElementById('new-admin-password').value;
                    if (password.length < 6) { alert('Kata sandi minimal 6 karakter.'); return; }
                    
                    await setDoc(adminConfigDocRef, { password });
                    settingsSuccess.textContent = 'Kata sandi admin berhasil disimpan!';
                    setTimeout(() => settingsSuccess.textContent = '', 3000);
                });
                
                document.getElementById('customer-login-form').addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const name = document.getElementById('customer-name').value;
                    const whatsapp = document.getElementById('customer-whatsapp').value;
                    const customerDocRef = doc(db, `artifacts/${appId}/public/data/customers`, whatsapp);
                    const docSnap = await getDoc(customerDocRef);

                    if (docSnap.exists()) {
                        const existingData = docSnap.data();
                        if (existingData.name !== name) {
                            document.getElementById('name-mismatch-message').textContent = `No. WhatsApp ini sudah terdaftar dengan nama "${existingData.name}". Gunakan nama ini?`;
                            document.getElementById('confirm-mismatch-btn').dataset.customer = JSON.stringify(existingData);
                            nameMismatchModal.classList.remove('hidden');
                        } else {
                            localStorage.setItem('customerData', JSON.stringify(existingData));
                            switchView('customer');
                        }
                    } else {
                        const customerData = { name, whatsapp };
                        await setDoc(customerDocRef, customerData);
                        localStorage.setItem('customerData', JSON.stringify(customerData));
                        switchView('customer');
                    }
                });

                document.getElementById('confirm-reset-btn').addEventListener('click', async () => {
                    const q = query(ordersCollectionRef, where("status", "==", "Selesai"));
                    const querySnapshot = await getDocs(q);
                    const deletePromises = [];
                    querySnapshot.forEach((doc) => {
                        deletePromises.push(deleteDoc(doc.ref));
                    });
                    await Promise.all(deletePromises);
                    resetConfirmationModal.classList.add('hidden');
                    generateReport('today'); // Refresh report
                });

                confirmOrderBtn.addEventListener('click', async () => {
                    confirmOrderBtn.disabled = true; confirmOrderBtn.textContent = 'Memproses...';
                    try {
                        const customerData = JSON.parse(localStorage.getItem('customerData'));
                        if (!customerData) {
                            alert("Sesi pelanggan tidak ditemukan, silakan login kembali.");
                            switchView('customer_login');
                            return;
                        }

                        const querySnapshot = await getDocs(ordersCollectionRef);
                        const newQueueNumber = querySnapshot.docs.reduce((max, doc) => Math.max(max, doc.data().queueNumber), 0) + 1;
                        await addDoc(ordersCollectionRef, {
                            queueNumber: newQueueNumber,
                            items: cart.map(item => ({ name: item.name, quantity: item.quantity, price: item.price })),
                            total: cart.reduce((sum, item) => sum + item.price * item.quantity, 0),
                            status: 'Masuk',
                            createdAt: serverTimestamp(),
                            customerName: customerData.name,
                            customerWhatsapp: customerData.whatsapp
                        });
                        orderConfirmationModal.classList.add('hidden');
                        successMessage.innerHTML = `Pesanan Anda adalah <strong>nomor antrian ${newQueueNumber}</strong>. Terima kasih!`;
                        successModal.classList.remove('hidden');
                    } catch (error) { console.error("Error adding document: ", error);
                    } finally { confirmOrderBtn.disabled = false; confirmOrderBtn.textContent = 'OK'; }
                });
                
                reportFilterButtons.addEventListener('click', (e) => {
                    if (e.target.matches('.report-filter-btn')) generateReport(e.target.dataset.filter);
                });

                customerSearchInput.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    const filteredCustomers = allCustomersCache.filter(customer => customer.whatsapp.includes(searchTerm));
                    renderCustomers(filteredCustomers);
                });

                renderMenu();
                renderCart();
                switchView('welcome'); // Start at welcome view

            } catch (error) {
                console.error("Authentication or initialization failed:", error);
                document.body.innerHTML = `<div class="text-center p-8 text-red-500">Gagal menginisialisasi aplikasi. Silakan coba lagi.</div>`;
            }
        };

        main();
    </script>

</body>
</html>
